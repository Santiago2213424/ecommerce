<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>Cambiar Contrase√±a | Smart Store</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet"
	      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">


    <style>
        body {
            background:#f4f6f9;
            font-family:'Poppins', sans-serif;
        }

        /* NAVBAR */
        .navbar {
            background:#0A3D62;
            padding:14px 30px !important;
        }
        .navbar a {
            color:white !important;
            font-weight:600;
            text-decoration:none !important;
            font-size:18px;
        }

        /* POPUP */
        #userPopup {
            position:absolute;
            right:0;
            top:35px;
            width:230px;
            padding:18px 20px;
            background:white;
            border-radius:12px;
            border:1px solid #dcdcdc;
            box-shadow:0 4px 15px rgba(0,0,0,0.25);
            display:none;
            opacity:0;
            transform:translateY(-10px);
            transition:.25s;
            z-index:5000;
            text-align:center;
        }
        .fade-in { opacity:1 !important; transform:translateY(0) !important; }
        .fade-out { opacity:0 !important; transform:translateY(-10px) !important; }

        #userPopup a {
            display:block;
            margin-top:10px;
            font-weight:600;
            color:rgb(0,0,160) !important;
        }
        #userPopup .logout-btn {
            margin-top:12px;
            background:#ff4d4d;
            color:white !important;
            padding:10px 0;
            border-radius:8px;
            font-weight:bold;
        }

        /* CARD */
        .card-box {
            background:white;
            max-width:480px;
            margin:60px auto;
            padding:30px;
            border-radius:14px;
            box-shadow:0 4px 12px rgba(0,0,0,0.10);
        }

        .btn-principal {
            background:#0A3D62;
            color:white;
            font-weight:600;
            border-radius:999px;
            padding:10px 18px;
			text-decoration: none !important;
        }

        .btn-principal:hover { background:#062742; }

        /* OJITOS */
        .input-wrapper {
            position: relative;
        }

        .toggle-eye {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            width: 22px;
            height: 22px;
        }

        /* SIDEBAR */
        #sideMenu {
            position:fixed;
            top:0; left:-260px;
            width:260px;
            height:100vh;
            background:#0A3D62;
            color:white;
            padding:20px;
            transition:left .3s ease-in-out;
            z-index:3000;
        }
        #sideMenu a {
            display:block;
            padding:10px;
            border-radius:6px;
            margin-bottom:6px;
            text-decoration:none;
            color:white !important;
        }
        #sideMenu a:hover { background:#07456F; }
        #closeMenu {
            font-size:26px;
            cursor:pointer;
            margin-bottom:15px;
        }
		
		/* üö´ Ocultar icono nativo de mostrar/ocultar contrase√±a (Chrome/Edge/Safari) */
		input[type="password"]::-ms-reveal,
		input[type="password"]::-ms-clear {
		    display: none;
		}

		input[type="password"]::-webkit-textfield-decoration-container {
		    display: none;
		}
		
		.nav-icon-link {
		    font-size:25px;
		    color:white !important;
		    display:inline-flex;
		    align-items:center;
		    justify-content:center;
		    cursor:pointer;
		}

    </style>
</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark">
    <span sec:authorize="hasRole('ADMIN')"
          style="font-size:26px; cursor:pointer; color:white;"
          onclick="openMenu()">&#9776;</span>

    <a class="navbar-brand ms-3"
       th:text="${#authorization.expression('hasRole(''ADMIN'')') ? 'Smart Store Admin' : 'Smart Store'}"
       th:href="${#authorization.expression('hasRole(''ADMIN'')') ? '/dashboard' : '/'}">
    </a>

    <div class="ms-auto d-flex align-items-center gap-4">

		<a sec:authorize="hasRole('ADMIN')" th:href="@{/carrito}" class="nav-icon-link">
		    <i class="bi bi-cart3"></i>
		</a>

		<a sec:authorize="hasRole('USER')" th:href="@{/carrito-usuario}" class="nav-icon-link">
		    <i class="bi bi-cart3"></i>
		</a>

        <div sec:authorize="isAuthenticated()" class="position-relative">
			<span id="userIcon" class="nav-icon-link" style="font-size:27px;">
			    <i class="bi bi-person-circle"></i>
			</span>

            <div id="userPopup">
                <p style="font-size:18px; font-weight:700;">
                    Hola <span sec:authentication="principal.nombre"></span>!
                </p>

                <a href="/perfil">Ver perfil</a>
                <a href="/mis-pedidos">Mis compras</a>

                <hr>

                <a href="/logout" class="logout-btn">Cerrar sesi√≥n</a>
            </div>
        </div>
    </div>
</nav>

<!-- SIDEBAR ADMIN -->
<div id="sideMenu" sec:authorize="hasRole('ADMIN')">
    <div id="closeMenu" onclick="closeMenu()">‚úñ</div>

    <a href="/dashboard">Dashboard</a>
    <a href="/products">Productos</a>
    <a href="/categorias">Categor√≠as</a>
    <a href="/ventas">Reporte de Ventas</a>
	<a href="/usuarios">Usuarios</a> 
	<a href="/estadisticas">Estadisticas</a>
</div>



<!-- BOT√ìN ATR√ÅS IGUAL AL PERFIL -->
<div class="container mb-3" style="margin-top:50px;">
    <a th:href="@{/perfil}" class="btn-principal" style="font-size:15px;">‚Üê Atr√°s</a>
</div>

<!-- FORMULARIO -->
<div class="card-box">

    <h3 class="fw-bold text-center mb-4">Cambiar Contrase√±a</h3>

    <div th:if="${error}" class="alert alert-danger text-center" th:text="${error}"></div>
    <div th:if="${success}" class="alert alert-success text-center" th:text="${success}"></div>

    <form th:action="@{/perfil/cambiar-password}" method="post" onsubmit="return validarCambio()">

        <!-- ACTUAL -->
        <div class="mb-3">
            <label class="fw-bold">Contrase√±a actual:</label>
            <div class="input-wrapper">
                <input type="password" name="actual" id="actual" class="form-control" required>

                <svg class="toggle-eye" onclick="togglePassword('actual', this)"
                     viewBox="0 0 24 24">
                    <path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7zm0 12a5 
                             5 0 110-10 5 5 0 010 10z"/>
                </svg>
            </div>
        </div>

        <!-- NUEVA -->
        <div class="mb-3">
            <label class="fw-bold">Nueva contrase√±a:</label>
            <div class="input-wrapper">
                <input type="password" name="nueva" id="nueva" class="form-control"
                       required pattern="(?=.*[A-Z])(?=.*\d)[A-Za-z\d]{7,}">
                <svg class="toggle-eye" onclick="togglePassword('nueva', this)"
                     viewBox="0 0 24 24">
                    <path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7zm0 12a5 
                             5 0 110-10 5 5 0 010 10z"/>
                </svg>
            </div>

            <small class="text-muted" style="font-size:12px;">
                Debe tener m√≠nimo <b>7 caracteres</b>, <b>1 may√∫scula</b> y <b>1 n√∫mero</b>.
            </small>
        </div>

        <!-- CONFIRMAR -->
        <div class="mb-3">
            <label class="fw-bold">Confirmar nueva contrase√±a:</label>

            <div class="input-wrapper">
                <input type="password" name="confirmar" id="confirmar" class="form-control" required>
                <svg class="toggle-eye" onclick="togglePassword('confirmar', this)"
                     viewBox="0 0 24 24">
                    <path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7zm0 12a5 
                             5 0 110-10 5 5 0 010 10z"/>
                </svg>
            </div>

            <small id="msgConfirm" class="text-danger" style="font-size:12px; display:none;">
                Las contrase√±as no coinciden.
            </small>
        </div>

        <button class="btn-principal w-100 mt-3">Actualizar contrase√±a</button>
    </form>
</div>

<script>
// OJITOS
function togglePassword(id, icon) {
    const input = document.getElementById(id);

    if (input.type === "password") {
        input.type = "text";
        icon.style.opacity = "0.5";
    } else {
        input.type = "password";
        icon.style.opacity = "1";
    }
}

// VALIDACIONES
function validarCambio() {
    const nueva = document.getElementById("nueva").value;
    const confirmar = document.getElementById("confirmar").value;
    const msg = document.getElementById("msgConfirm");

    if (nueva !== confirmar) {
        msg.style.display = "block";
        return false;
    }
    return true;
}

document.getElementById("confirmar").addEventListener("input", () => {
    const nueva = document.getElementById("nueva").value;
    const confirmar = document.getElementById("confirmar").value;
    const msg = document.getElementById("msgConfirm");

    msg.style.display = (nueva !== confirmar) ? "block" : "none";
});

// POPUP & SIDEBAR
function openMenu(){ document.getElementById("sideMenu").style.left="0"; }
function closeMenu(){ document.getElementById("sideMenu").style.left="-260px"; }

const userIcon=document.getElementById("userIcon");
const popup=document.getElementById("userPopup");

userIcon.addEventListener("click",(e)=>{
    e.stopPropagation();
    popup.style.display==="block" ? hidePopup() : showPopup();
});

function showPopup(){
    popup.style.display="block";
    requestAnimationFrame(()=>popup.classList.add("fade-in"));
}
function hidePopup(){
    popup.classList.remove("fade-in");
    popup.classList.add("fade-out");
    setTimeout(()=>{
        popup.style.display="none";
        popup.classList.remove("fade-out");
    },250);
}

document.addEventListener("click",(e)=>{
    if(!popup.contains(e.target) && e.target!==userIcon){
        hidePopup();
    }
});

document.addEventListener("click",(e)=>{
    const menu=document.getElementById("sideMenu");
    if(menu.style.left!=="0px") return;

    if(!menu.contains(e.target) && e.target.getAttribute("onclick")!=="openMenu()"){
        closeMenu();
    }
});
</script>

</body>
</html>
