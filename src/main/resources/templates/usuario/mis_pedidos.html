<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>Mis pedidos | Smart Store</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet"
	      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">


    <style>
        body {
            background:#f4f6f9;
            font-family:'Poppins', sans-serif;
        }

        /* NAVBAR */
        .navbar {
            background:#0A3D62;
            padding:14px 30px !important;
        }

        .navbar a {
            color:white !important;
            font-weight:600;
            font-size:18px;
            text-decoration:none !important;
        }

        /* √çcono men√∫ estilo delgado */
        .menu-icon {
            font-size:26px;
            cursor:pointer;
            color:white !important;
            font-weight:300; 
        }

        /* SIDEBAR */
        #sideMenu {
            position:fixed;
            top:0;
            left:-260px;
            width:260px;
            height:100vh;
            background:#0A3D62;
            color:white;
            padding:20px;
            transition:left .3s ease;
            z-index:3000;
        }
        #sideMenu a {
            display:block;
            padding:10px;
            border-radius:6px;
            color:white !important;
            text-decoration:none !important;
            margin-bottom:6px;
        }
        #sideMenu a:hover { background:#07456F; }

        #closeMenu {
            font-size:26px;
            cursor:pointer;
            margin-bottom:15px;
            color:white;
        }

        /* POPUP */
		/* POPUP UNIFICADO */
		#userPopup {
		    position: absolute;
		    right: 0;
		    top: 35px;
		    width: 230px;
		    background: white !important;
		    padding: 18px 20px;
		    border-radius: 12px;
		    border: 1px solid #dcdcdc;
		    box-shadow: 0 4px 15px rgba(0,0,0,0.25);
		    display: none;
		    opacity: 0;
		    transform: translateY(-10px);
		    transition: opacity .25s ease, transform .25s ease;
		    text-align: center;
		    z-index: 5000;
		}

		/* Texto enlaces */
		#userPopup a {
		    display: block;
		    margin-top: 10px;     /* <- mismo en todos */
		    font-weight: 600;
		    color: rgb(0,0,160) !important;
		    text-decoration: none !important;
		}

		/* L√≠nea */
		#userPopup hr {
		    margin: 12px 0;       /* <- igual en todos */
		}

		/* Bot√≥n de logout */
		#userPopup .logout-btn {
		    background: #ff4d4d !important;
		    color: white !important;
		    font-weight: bold;
		    padding: 10px 0;
		    border-radius: 8px;
		    margin-top: 10px;
		}
		
		#userPopup hr {
			margin: 6px 0;     
		}

		#userPopup .logout-btn {
		   margin-top: 10px;   
		   display: block;
		   width: 100%;      
		}

		.fade-in  { opacity: 1 !important; transform: translateY(0) !important; }
		.fade-out { opacity: 0 !important; transform: translateY(-10px) !important; }

        /* P√ÅGINA */
        .pedido-card {
            background:white;
            border-radius:12px;
            padding:18px 20px;
            margin-bottom:16px;
            box-shadow:0 3px 10px rgba(0,0,0,0.06);
        }

        .producto-linea {
            display:flex;
            justify-content:space-between;
            border-bottom:1px dashed #eee;
            padding:4px 0;
        }

        .btn-volver {
            background:#0A3D62;
            color:white;
            padding:8px 18px;
            border-radius:999px;
            font-weight:600;
        }

        /* BADGES ESTADO */
		.estado-badge {
		    padding: 6px 18px;     
		    font-size: 13px;
		    font-weight:600;
		    border-radius: 22px;  
		    display:inline-flex;
		    justify-content:center;
		    align-items:center;
		    min-width:90px;      
		    border:2px solid #a8c7e6;
		    background:#e9f3ff;
		    color:#0A3D62;
		}

        .estado-TIENDA { background:#E8F1FB; border-color:#AFCDEA; }
        .estado-EN_CAMINO { background:#FFF4D9; color:#8A6D00; border-color:#F5D98B; }
        .estado-ENTREGADO { background:#E9FBEF; color:#1E824C; border-color:#AEEBC3; }
        .estado-CANCELADO { background:#FDECEC; color:#C0392B; border-color:#F5B7B1; }
		
		#userPopup p {
		    margin: 0 !important;
		    line-height: 1.1;  /* opcional, m√°s compacto todav√≠a */
		}
		
		.nav-icon-link {
		    font-size:25px;
		    color:white !important;
		    display:inline-flex;
		    align-items:center;
		    justify-content:center;
		    cursor:pointer;
		}
		

    </style>
</head>

<body>

<!-- NAVBAR USER (TIENDA) -->
<nav class="navbar navbar-expand-lg navbar-dark"
     th:if="${#authentication.principal.usuario.rol.name() == 'USER'}">

    <a class="navbar-brand" href="/">Smart Store</a>

    <div class="ms-auto d-flex align-items-center gap-4">

		<!-- üë§ USUARIO -->
		<div sec:authorize="isAuthenticated()" class="position-relative">
			<span id="userIcon" class="nav-icon-link d-flex align-items-center" style="font-size:20px; cursor:pointer;">
						        <i class="bi bi-person-circle"></i>

						        <!-- SEPARACI√ìN DEL TEXTO -->
						        <span style="margin-left:8px;">
						            <span sec:authentication="principal.nombre"></span>
						            <span sec:authentication="principal.apellido"></span>
						        </span>
						    </span>

		    <div id="userPopup">
		        <p style="margin:0; font-size:18px; font-weight:700;">
		            Hola <span sec:authentication="principal.nombre"></span>!
		        </p>

		        <a th:href="@{/perfil}">Ver perfil</a>
		        <a th:href="@{/mis-pedidos}">Mis compras</a>
		        <hr>
		        <a th:href="@{/logout}" class="logout-btn">Cerrar sesi√≥n</a>
		    </div>
		</div>

		
    </div>
</nav>


<!-- NAVBAR ADMIN -->
<nav class="navbar navbar-expand-lg navbar-dark"
     th:if="${#authentication.principal.usuario.rol.name() == 'ADMIN'}">

    <span class="menu-icon" onclick="openMenu()">&#9776;</span>

    <a class="navbar-brand ms-3" href="/dashboard">Smart Store Admin</a>

    <div class="ms-auto d-flex align-items-center gap-4">
		<!-- üõí CARRITO -->
		<a th:href="@{/carrito}" class="nav-icon-link">
		    <i class="bi bi-cart3"></i>
		</a>

		<!-- üë§ USUARIO -->
		<div sec:authorize="isAuthenticated()" class="position-relative">
		    <span id="userIcon" class="nav-icon-link" style="font-size:27px;">
		        <i class="bi bi-person-circle"></i>
		    </span>

		    <div id="userPopup">
		        <p style="margin:0; font-size:18px; font-weight:700;">
		            Hola <span sec:authentication="principal.nombre"></span>!
		        </p>

		        <a th:href="@{/perfil}">Ver perfil</a>
		        <a th:href="@{/mis-pedidos}">Mis compras</a>
		        <hr>
		        <a th:href="@{/logout}" class="logout-btn">Cerrar sesi√≥n</a>
		    </div>
		</div>

    </div>
</nav>


<!-- SIDEBAR ADMIN -->
<div id="sideMenu" th:if="${#authentication.principal.usuario.rol.name() == 'ADMIN'}">

    <div id="closeMenu" onclick="closeMenu()">‚úñ</div>

    <a href="/dashboard">Dashboard</a>
    <a href="/products">Productos</a>
    <a href="/categorias">Categor√≠as</a>
    <a href="/ventas">Reporte de Ventas</a>
    <a href="/usuarios">Usuarios</a>
</div>


<!-- CONTENIDO (SIN CAMBIOS) -->
<div class="container mt-4 mb-5">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="page-title">Mis pedidos</h2>

        <a th:if="${#authentication.principal.usuario.rol.name() == 'ADMIN'}"
           href="/dashboard" class="btn-volver">‚Üê Volver al Dashboard</a>

        <a th:if="${#authentication.principal.usuario.rol.name() == 'USER'}"
           href="/compras" class="btn-volver">‚Üê Seguir comprando</a>
    </div>

    <div th:each="v : ${pedidos}" class="pedido-card"
         th:if="${!#lists.isEmpty(pedidos)}">

        <div class="d-flex justify-content-between">
            <div>
                <div class="fw-bold">Pedido #<span th:text="${v.id}"></span></div>
                <div style="font-size:13px; color:#777;">
                    Realizado el <span th:text="${#temporals.format(v.fecha,'dd/MM/yyyy HH:mm')}"></span>
                </div>
            </div>

            <span class="estado-badge"
                  th:classappend="' estado-' + ${v.estado}"
                  th:text="${v.estado}">
            </span>
        </div>

        <hr>

        <div class="row">
            <div class="col-md-4">
                <div class="text-muted">Total</div>
                <div class="fw-bold">S/<span th:text="${v.total}"></span></div>
            </div>

            <div class="col-md-4">
                <div class="text-muted">Pago</div>
                <div th:text="${v.metodoPago}"></div>
            </div>

            <div class="col-md-4">
                <div class="text-muted">Entrega</div>
                <div>
                    <span th:text="${v.modalidadEntrega}"></span>
                    <span th:if="${v.direccionEntrega}">
                        ‚Äì <span th:text="${v.direccionEntrega}"></span>
                    </span>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <div class="text-muted mb-1">Productos</div>

            <div th:each="d : ${v.detalles}" class="producto-linea">
                <div>
                    <strong th:text="${d.producto.nombre}"></strong>
                    <span class="text-muted" style="font-size:12px;">
                        ¬∑ Cant: <span th:text="${d.cantidad}"></span>
                    </span>
                </div>
                <div>S/ <span th:text="${d.subtotal}"></span></div>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script>
function openMenu(){ document.getElementById("sideMenu").style.left="0"; }
function closeMenu(){ document.getElementById("sideMenu").style.left="-260px"; }

/* POPUP */
const userIcon = document.getElementById("userIcon");
const popup = document.getElementById("userPopup");

if (userIcon) {
    function showPopup() {
        popup.style.display = "block";
        requestAnimationFrame(() => popup.classList.add("fade-in"));
    }

    function hidePopup() {
        popup.classList.remove("fade-in");
        popup.classList.add("fade-out");

        setTimeout(() => {
            popup.style.display = "none";
            popup.classList.remove("fade-out");
        }, 250);
    }

    userIcon.addEventListener("click", (e) => {
        e.stopPropagation();
        popup.style.display === "block" ? hidePopup() : showPopup();
    });

    document.addEventListener("click", (e) => {
        if (!popup.contains(e.target) && e.target !== userIcon) {
            hidePopup();
        }
    });
}

document.addEventListener("click", (e) => {

    const menu = document.getElementById("sideMenu");
    const isMenuOpen = menu.style.left === "0px";

    if (!isMenuOpen) return;

    const clickedInsideMenu = menu.contains(e.target);
    const clickedOpenButton = e.target.getAttribute("onclick") === "openMenu()";

    if (!clickedInsideMenu && !clickedOpenButton) {
        closeMenu();
    }
});
</script>

</body>
</html>
