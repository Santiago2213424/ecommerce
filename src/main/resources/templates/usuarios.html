<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Usuarios | Smart Store Admin</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet"
		  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	  

    <style>
        body {
            background:#f4f6f9;
            font-family:'Poppins', sans-serif;
            margin:0;
        }

        /* NAVBAR */
        .navbar {
            background:#0A3D62;
            padding:14px 30px !important;
        }
        .navbar a {
            color:white !important;
            font-weight:600;
            font-size:18px;
            text-decoration:none !important;
        }

        /* SIDEBAR */
        #sideMenu {
            position: fixed;
            top:0;
            left:-260px;
            width:260px;
            height:100vh;
            background:#0A3D62;
            color:white;
            padding:20px;
            transition:left .3s;
            z-index:3000;
        }
        #sideMenu a {
            display:block;
            padding:10px;
            border-radius:6px;
            color:white !important;
            margin-bottom:6px;
            text-decoration:none !important;
        }
        #sideMenu a:hover { background:#07456F; }
        #closeMenu { font-size:26px; cursor:pointer; margin-bottom:15px; }

        /* POPUP */
        #userPopup {
            position:absolute;
            right:0;
            top:35px;
            width:230px;
            background:white;
            border-radius:12px;
            padding:18px 20px;
            border:1px solid #dcdcdc;
            box-shadow:0 4px 15px rgba(0,0,0,0.25);
            display:none;
            opacity:0;
            transform:translateY(-10px);
            transition:.25s;
            text-align:center;
            z-index:5000;
        }
        .fade-in  { opacity:1 !important; transform:translateY(0) !important; }
        .fade-out { opacity:0 !important; transform:translateY(-10px) !important; }

        #userPopup a {
            display:block;
            font-weight:600;
            color:rgb(0,0,160) !important;
            margin-top:10px;
        }
		
        #userPopup .logout-btn {
            background:#ff4d4d;
            color:white !important;
            padding:10px 0;
            border-radius:8px;
            display:block;
            margin-top:12px;
        }
		
		#userPopup hr {
		    margin: 6px 0;    
		}

		#userPopup .logout-btn {
		    margin-top: 14px;  
		    display: block;
		    width: 100%;       
		}

        /* CONTENIDO */
        .content { padding:40px; display:flex; justify-content:center; }
        .content-wrap { width:100%; max-width:1300px; }  /* ðŸ”¹ MÃ¡s ancho */

        .card {
            border-radius: 14px;
            padding: 25px;
            background:white;
            box-shadow:0 4px 12px rgba(0,0,0,0.1);
        }

        .btn-mini {
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 13px;
        }

        .menu-icon,
        .menu-icon:focus,
        .menu-icon:active,
        .menu-icon:hover {
            text-decoration:none !important;
            outline:none !important;
            border:none !important;
            box-shadow:none !important;
        }

        .badge-rol {
            font-size: 12px;
            padding: 6px 10px;
        }

       
        .col-nombre,
        .col-correo {
            max-width: 260px;          
            word-wrap: break-word;
            word-break: break-all;    
            white-space: normal;
        }
		
		.badge-rol {
		    display: inline-flex;
		    align-items: center;
		    justify-content: center;
		    min-width: 80px;    
		    height: 32px;       
		    font-size: 13px;
		}

		
		.action-cell {
		    display: flex;
		    justify-content: center;
		    align-items: center;
		    gap: 10px;
		    height: 38px; 
		}
		
		td .action-cell {
		    min-width: 250px;
		}
		
		.nav-icon-link {
		    font-size:25px;
		    color:white !important;
		    display:inline-flex;
		    align-items:center;
		    justify-content:center;
		    cursor:pointer;
		}


    </style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <span class="menu-icon"
          style="font-size:26px; cursor:pointer; color:white;"
          onclick="openMenu()">&#9776;</span>

    <a class="navbar-brand ms-3" href="/dashboard">Smart Store Admin</a>

    <div class="ms-auto d-flex align-items-center gap-4">
		<!-- ðŸ›’ CARRITO -->
		<a th:href="@{/carrito}" class="nav-icon-link">
		    <i class="bi bi-cart3"></i>
		</a>

		<!-- ðŸ‘¤ USUARIO -->
		<div sec:authorize="isAuthenticated()" class="position-relative">
		    <span id="userIcon" class="nav-icon-link" style="font-size:27px;">
		        <i class="bi bi-person-circle"></i>
		    </span>

		    <div id="userPopup">
		        <p style="margin:0; font-size:18px; font-weight:700;">
		            Hola <span sec:authentication="principal.nombre"></span>!
		        </p>

		        <a th:href="@{/perfil}">Ver perfil</a>
		        <a th:href="@{/mis-pedidos}">Mis compras</a>
		        <hr>
		        <a th:href="@{/logout}" class="logout-btn">Cerrar sesiÃ³n</a>
		    </div>
		</div>

		
    </div>
</nav>

<!-- SIDEBAR -->
<div id="sideMenu">
    <div id="closeMenu" onclick="closeMenu()">âœ–</div>
    <a href="/dashboard">Dashboard</a>
    <a href="/products">Productos</a>
    <a href="/categorias">CategorÃ­as</a>
    <a href="/ventas">Reporte de Ventas</a>
    <a href="/usuarios">Usuarios</a>
	<a href="/estadisticas">Estadisticas</a>
</div>

<!-- CONTENIDO -->
<div class="content">
    <div class="content-wrap">

        <h2 class="fw-bold mb-4 text-center">GestiÃ³n de Usuarios</h2>

        <div class="card">

            <!-- ðŸ”¹ Hacemos la tabla responsive por si igual se pasa -->
            <div class="table-responsive">
                <table class="table table-striped align-middle text-center">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Correo</th>
                        <th>Rol</th>
                        <th>Estado / Cuenta</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="u : ${usuarios}">
                        <td th:text="${u.id}"></td>
                        <td class="col-nombre" th:text="${u.nombre} + ' ' + ${u.apellido}"></td>
                        <td class="col-correo" th:text="${u.correo}"></td>

                        <!-- ========== COL ROL ========== -->
                        <td>
                            <div class="action-cell">
                                <span class="badge bg-primary badge-rol" th:text="${u.rol}"></span>

                                <form th:action="@{'/usuarios/cambiar-rol/' + ${u.id}}"
                                      method="post"
                                      class="d-flex align-items-center gap-2">

                                    <select name="nuevoRol" class="form-select form-select-sm w-auto">
                                        <option value="ADMIN" th:selected="${u.rol == 'ADMIN'}">ADMIN</option>
                                        <option value="USER"  th:selected="${u.rol == 'USER'}">USER</option>
                                    </select>

                                    <button class="btn btn-success btn-mini">Cambiar</button>
                                </form>
                            </div>
                        </td>

                        <!-- ========== COL ESTADO ========== -->
                        <td>
                            <div class="action-cell">

                                <span th:if="${u.activo}" class="badge bg-success badge-rol">ACTIVO</span>
                                <span th:if="${!u.activo}" class="badge bg-secondary badge-rol">INACTIVO</span>

                                <form th:action="@{'/usuarios/estado/' + ${u.id}}"
                                      method="post"
                                      onsubmit="return enviarAccionEstado(this)"
                                      class="d-inline-flex align-items-center gap-1">

                                    <select name="accionEstado" class="form-select form-select-sm w-auto">
                                        <option value="ACTIVO"   th:selected="${u.activo}">ACTIVO</option>
                                        <option value="INACTIVO" th:selected="${!u.activo}">INACTIVO</option>
                                        <option value="ELIMINAR">Eliminar cuenta</option>
                                    </select>

                                    <button class="btn btn-warning btn-mini">Aplicar</button>
                                </form>
                            </div>
                        </td>

                    </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ==== SIDEBAR ====
function openMenu() {
    const menu = document.getElementById("sideMenu");
    if (menu) menu.style.left = "0";
}
function closeMenu() {
    const menu = document.getElementById("sideMenu");
    if (menu) menu.style.left = "-260px";
}

document.addEventListener("click", (e) => {
    const sideMenu = document.getElementById("sideMenu");
    if (!sideMenu) return;

    const isOpen = sideMenu.style.left === "0px";
    if (!isOpen) return;

    const clickedInsideMenu = sideMenu.contains(e.target);
    const clickedOpenButton = e.target.getAttribute("onclick") === "openMenu()";

    if (!clickedInsideMenu && !clickedOpenButton) {
        closeMenu();
    }
});

// ==== POPUP USUARIO ====
document.addEventListener("DOMContentLoaded", () => {
    const userIcon = document.getElementById("userIcon");
    const popup = document.getElementById("userPopup");

    if (!(userIcon && popup)) return;

    function showPopup() {
        popup.style.display = "block";
        requestAnimationFrame(() => popup.classList.add("fade-in"));
    }
    function hidePopup() {
        popup.classList.remove("fade-in");
        popup.classList.add("fade-out");
        setTimeout(() => {
            popup.style.display = "none";
            popup.classList.remove("fade-out");
        }, 250);
    }

    userIcon.addEventListener("click", (e) => {
        e.stopPropagation();
        popup.style.display === "block" ? hidePopup() : showPopup();
    });

    document.addEventListener("click", (e) => {
        if (!popup.contains(e.target) && e.target !== userIcon) {
            hidePopup();
        }
    });
});

// ==== LÃ“GICA ESTADO ====
function enviarAccionEstado(form) {
    const accion = form.querySelector("select[name='accionEstado']").value;
    const id = form.action.split("/").pop(); // obtiene el ID final

    if (accion === "INACTIVO") {
        form.action = "/usuarios/inhabilitar/" + id;
    } 
    else if (accion === "ACTIVO") {
        form.action = "/usuarios/habilitar/" + id;
    }
    else if (accion === "ELIMINAR") {
        if (!confirm("Â¿Seguro que deseas borrar esta cuenta?")) {
            return false;
        }
        form.action = "/usuarios/eliminar/" + id;
    }

    return true;
}
</script>

</body>
</html>
